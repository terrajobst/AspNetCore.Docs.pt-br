---
title: Gerenciamento de chaves no ASP.NET Core
author: rick-anderson
description: Aprenda detalhes de implementação das APIs de gerenciamento de chaves de proteção de dados ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: c571222d734fa69183563aefa5cc6ce5a10e7612
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78664706"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="c25b6-103">Gerenciamento de chaves no ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="c25b6-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="c25b6-104">O sistema de proteção de dados gerencia automaticamente o tempo de vida das chaves mestras usadas para proteger e desproteger cargas.</span><span class="sxs-lookup"><span data-stu-id="c25b6-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="c25b6-105">Cada chave pode existir em um dos quatro estágios:</span><span class="sxs-lookup"><span data-stu-id="c25b6-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="c25b6-106">Criado-a chave existe no anel de chave, mas ainda não foi ativada.</span><span class="sxs-lookup"><span data-stu-id="c25b6-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="c25b6-107">A chave não deve ser usada para novas operações de proteção até que o tempo suficiente tenha decorrido que a chave tenha tido a oportunidade de se propagar para todos os computadores que estão consumindo esse anel de chave.</span><span class="sxs-lookup"><span data-stu-id="c25b6-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="c25b6-108">Ativo-a chave existe no anel de chave e deve ser usada para todas as novas operações de proteção.</span><span class="sxs-lookup"><span data-stu-id="c25b6-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="c25b6-109">Expirado-a chave executou seu tempo de vida natural e não deve mais ser usada para novas operações de proteção.</span><span class="sxs-lookup"><span data-stu-id="c25b6-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="c25b6-110">Revogado-a chave está comprometida e não deve ser usada para novas operações de proteção.</span><span class="sxs-lookup"><span data-stu-id="c25b6-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="c25b6-111">As chaves criadas, ativas e expiradas podem ser usadas para desproteger as cargas de entrada.</span><span class="sxs-lookup"><span data-stu-id="c25b6-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="c25b6-112">As chaves revogadas por padrão não podem ser usadas para desproteger cargas, mas o desenvolvedor do aplicativo pode [substituir esse comportamento](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) , se necessário.</span><span class="sxs-lookup"><span data-stu-id="c25b6-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="c25b6-113">O desenvolvedor pode ser tentado a excluir uma chave do anel de chave (por exemplo, excluindo o arquivo correspondente do sistema de arquivos).</span><span class="sxs-lookup"><span data-stu-id="c25b6-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="c25b6-114">Nesse ponto, todos os dados protegidos pela chave são permanentemente indecifráveis, e não há nenhuma substituição de emergência como há com chaves revogadas.</span><span class="sxs-lookup"><span data-stu-id="c25b6-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="c25b6-115">A exclusão de uma chave é um comportamento realmente destrutivo e, consequentemente, o sistema de proteção de dados não expõe nenhuma API de primeira classe para executar essa operação.</span><span class="sxs-lookup"><span data-stu-id="c25b6-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="c25b6-116">Seleção de chave padrão</span><span class="sxs-lookup"><span data-stu-id="c25b6-116">Default key selection</span></span>

<span data-ttu-id="c25b6-117">Quando o sistema de proteção de dados lê o anel de chave do repositório de backup, ele tentará localizar uma chave "padrão" do anel de chave.</span><span class="sxs-lookup"><span data-stu-id="c25b6-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="c25b6-118">A chave padrão é usada para novas operações de proteção.</span><span class="sxs-lookup"><span data-stu-id="c25b6-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="c25b6-119">A heurística geral é que o sistema de proteção de dados escolhe a chave com a data de ativação mais recente como a chave padrão.</span><span class="sxs-lookup"><span data-stu-id="c25b6-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="c25b6-120">(Há um pequeno fator de adequações para permitir a distorção de relógio de servidor para servidor.) Se a chave estiver expirada ou revogada, e se o aplicativo não tiver desabilitado a geração automática de chaves, uma nova chave será gerada com ativação imediata de acordo com a [expiração de chave e a política de interrupção](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) abaixo.</span><span class="sxs-lookup"><span data-stu-id="c25b6-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="c25b6-121">O motivo pelo qual o sistema de proteção de dados gera uma nova chave imediatamente em vez de fazer fallback para uma chave diferente é que a nova geração de chave deve ser tratada como uma expiração implícita de todas as chaves que foram ativadas antes da nova chave.</span><span class="sxs-lookup"><span data-stu-id="c25b6-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="c25b6-122">A ideia geral é que as novas chaves podem ter sido configuradas com algoritmos diferentes ou mecanismos de criptografia em repouso do que as chaves antigas, e o sistema deve preferir a configuração atual ao fazer o fallback.</span><span class="sxs-lookup"><span data-stu-id="c25b6-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="c25b6-123">Há uma exceção.</span><span class="sxs-lookup"><span data-stu-id="c25b6-123">There's an exception.</span></span> <span data-ttu-id="c25b6-124">Se o desenvolvedor do aplicativo tiver [desabilitado a geração automática de chaves](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), o sistema de proteção de dados deverá escolher algo como a chave padrão.</span><span class="sxs-lookup"><span data-stu-id="c25b6-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="c25b6-125">Nesse cenário de fallback, o sistema escolherá a chave não revogada com a data de ativação mais recente, com preferência dada às chaves que tiveram tempo para se propagar para outros computadores no cluster.</span><span class="sxs-lookup"><span data-stu-id="c25b6-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="c25b6-126">O sistema de fallback pode acabar escolhendo uma chave padrão expirada como resultado.</span><span class="sxs-lookup"><span data-stu-id="c25b6-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="c25b6-127">O sistema de fallback nunca escolherá uma chave revogada como a chave padrão e, se o anel de chave estiver vazio ou cada chave tiver sido revogada, o sistema produzirá um erro na inicialização.</span><span class="sxs-lookup"><span data-stu-id="c25b6-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="c25b6-128">Expiração de chave e sem interrupção</span><span class="sxs-lookup"><span data-stu-id="c25b6-128">Key expiration and rolling</span></span>

<span data-ttu-id="c25b6-129">Quando uma chave é criada, ela recebe automaticamente uma data de ativação de {Now + 2 dias} e uma data de expiração de {Now + 90 dias}.</span><span class="sxs-lookup"><span data-stu-id="c25b6-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="c25b6-130">O atraso de 2 dias antes da ativação dá ao momento da chave a propagação no sistema.</span><span class="sxs-lookup"><span data-stu-id="c25b6-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="c25b6-131">Ou seja, ele permite que outros aplicativos apontem para o armazenamento de backup para observar a chave em seu próximo período de atualização automática, maximizando a probabilidade de quando o anel de chave se torna ativo, propagando-o para todos os aplicativos que talvez precisem usá-lo.</span><span class="sxs-lookup"><span data-stu-id="c25b6-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="c25b6-132">Se a chave padrão expirar em 2 dias e se o anel de chave ainda não tiver uma chave que estará ativa após a expiração da chave padrão, o sistema de proteção de dados manterá automaticamente uma nova chave para o anel de chave.</span><span class="sxs-lookup"><span data-stu-id="c25b6-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="c25b6-133">Essa nova chave tem uma data de ativação de {data de validade da chave padrão} e uma data de expiração de {Now + 90 dias}.</span><span class="sxs-lookup"><span data-stu-id="c25b6-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="c25b6-134">Isso permite que o sistema acumule automaticamente as chaves regularmente sem interrupção do serviço.</span><span class="sxs-lookup"><span data-stu-id="c25b6-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="c25b6-135">Pode haver circunstâncias em que uma chave será criada com ativação imediata.</span><span class="sxs-lookup"><span data-stu-id="c25b6-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="c25b6-136">Um exemplo seria quando o aplicativo não for executado por um tempo e todas as chaves no anel de chave estiverem expiradas.</span><span class="sxs-lookup"><span data-stu-id="c25b6-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="c25b6-137">Quando isso acontece, a chave recebe uma data de ativação de {Now} sem o atraso de ativação normal de 2 dias.</span><span class="sxs-lookup"><span data-stu-id="c25b6-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="c25b6-138">O tempo de vida da chave padrão é de 90 dias, embora isso seja configurável como no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="c25b6-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="c25b6-139">Um administrador também pode alterar o sistema padrão, embora uma chamada explícita para `SetDefaultKeyLifetime` substitua qualquer política de todo o sistema.</span><span class="sxs-lookup"><span data-stu-id="c25b6-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="c25b6-140">O tempo de vida da chave padrão não pode ser menor que 7 dias.</span><span class="sxs-lookup"><span data-stu-id="c25b6-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="c25b6-141">Atualização automática de anel de chave</span><span class="sxs-lookup"><span data-stu-id="c25b6-141">Automatic key ring refresh</span></span>

<span data-ttu-id="c25b6-142">Quando o sistema de proteção de dados é inicializado, ele lê o anel de chave do repositório subjacente e o armazena em cache na memória.</span><span class="sxs-lookup"><span data-stu-id="c25b6-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="c25b6-143">Esse cache permite que as operações proteger e desproteger continuem sem alcançar o armazenamento de backup.</span><span class="sxs-lookup"><span data-stu-id="c25b6-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="c25b6-144">O sistema verificará automaticamente o repositório de backup em busca de alterações aproximadamente a cada 24 horas ou quando a chave padrão atual expirar, o que ocorrer primeiro.</span><span class="sxs-lookup"><span data-stu-id="c25b6-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="c25b6-145">Os desenvolvedores devem muito raramente (se nunca) precisarem usar as APIs de gerenciamento de chaves diretamente.</span><span class="sxs-lookup"><span data-stu-id="c25b6-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="c25b6-146">O sistema de proteção de dados executará o gerenciamento automático de chaves, conforme descrito acima.</span><span class="sxs-lookup"><span data-stu-id="c25b6-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="c25b6-147">O sistema de proteção de dados expõe uma interface `IKeyManager` que pode ser usada para inspecionar e fazer alterações no anel de chave.</span><span class="sxs-lookup"><span data-stu-id="c25b6-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="c25b6-148">O sistema de DI que forneceu a instância do `IDataProtectionProvider` também pode fornecer uma instância de `IKeyManager` para seu consumo.</span><span class="sxs-lookup"><span data-stu-id="c25b6-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="c25b6-149">Como alternativa, você pode extrair o `IKeyManager` diretamente do `IServiceProvider` como no exemplo abaixo.</span><span class="sxs-lookup"><span data-stu-id="c25b6-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="c25b6-150">Qualquer operação que modifique o anel de chave (criando uma nova chave explicitamente ou executando uma revogação) invalidará o cache na memória.</span><span class="sxs-lookup"><span data-stu-id="c25b6-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="c25b6-151">A próxima chamada para `Protect` ou `Unprotect` fará com que o sistema de proteção de dados leia novamente o anel de chave e recrie o cache.</span><span class="sxs-lookup"><span data-stu-id="c25b6-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="c25b6-152">O exemplo a seguir demonstra como usar a interface `IKeyManager` para inspecionar e manipular o anel de tecla, incluindo a revogação de chaves existentes e a geração manual de uma nova chave.</span><span class="sxs-lookup"><span data-stu-id="c25b6-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

[!INCLUDE[about the series](~/includes/code-comments-loc.md)]

## <a name="key-storage"></a><span data-ttu-id="c25b6-153">Armazenamento de chaves</span><span class="sxs-lookup"><span data-stu-id="c25b6-153">Key storage</span></span>

<span data-ttu-id="c25b6-154">O sistema de proteção de dados tem uma heurística em que tenta deduzir automaticamente um local apropriado de armazenamento de chaves e o mecanismo de criptografia em repouso.</span><span class="sxs-lookup"><span data-stu-id="c25b6-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="c25b6-155">O mecanismo de persistência de chave também é configurável pelo desenvolvedor do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="c25b6-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="c25b6-156">Os documentos a seguir discutem as implementações internas desses mecanismos:</span><span class="sxs-lookup"><span data-stu-id="c25b6-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
