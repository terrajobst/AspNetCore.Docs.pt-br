---
title: Controle de versão de serviços gRPCs
author: jamesnk
description: Saiba como os serviços gRPCs de versão.
monikerRange: '>= aspnetcore-3.0'
ms.author: jamesnk
ms.date: 01/09/2020
uid: grpc/versioning
ms.openlocfilehash: 9bd76009ba28a1abef25a98686afea6753d4a8f4
ms.sourcegitcommit: 7dfe6cc8408ac6a4549c29ca57b0c67ec4baa8de
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/09/2020
ms.locfileid: "75828510"
---
# <a name="versioning-grpc-services"></a><span data-ttu-id="65b4e-103">Controle de versão de serviços gRPCs</span><span class="sxs-lookup"><span data-stu-id="65b4e-103">Versioning gRPC services</span></span>

<span data-ttu-id="65b4e-104">Por [James Newton – King](https://twitter.com/jamesnk)</span><span class="sxs-lookup"><span data-stu-id="65b4e-104">By [James Newton-King](https://twitter.com/jamesnk)</span></span>

<span data-ttu-id="65b4e-105">Os novos recursos adicionados a um aplicativo podem exigir que os serviços gRPCs fornecidos aos clientes mudem, às vezes de formas inesperadas e de interrupção.</span><span class="sxs-lookup"><span data-stu-id="65b4e-105">New features added to an app can require gRPC services provided to clients to change, sometimes in unexpected and breaking ways.</span></span> <span data-ttu-id="65b4e-106">Quando os serviços gRPCs forem alterados:</span><span class="sxs-lookup"><span data-stu-id="65b4e-106">When gRPC services change:</span></span>

* <span data-ttu-id="65b4e-107">A consideração deve ser dada em como as alterações afetam os clientes.</span><span class="sxs-lookup"><span data-stu-id="65b4e-107">Consideration should be given on how changes impact clients.</span></span>
* <span data-ttu-id="65b4e-108">Uma estratégia de controle de versão para dar suporte a alterações deve ser implementada.</span><span class="sxs-lookup"><span data-stu-id="65b4e-108">A versioning strategy to support changes should be implemented.</span></span>

## <a name="backwards-compatibility"></a><span data-ttu-id="65b4e-109">Compatibilidade com versões anteriores</span><span class="sxs-lookup"><span data-stu-id="65b4e-109">Backwards compatibility</span></span>

<span data-ttu-id="65b4e-110">O protocolo gRPC foi projetado para dar suporte a serviços que mudam com o passar do tempo.</span><span class="sxs-lookup"><span data-stu-id="65b4e-110">The gRPC protocol is designed to support services that change over time.</span></span> <span data-ttu-id="65b4e-111">Em geral, as adições aos serviços e métodos gRPC são não separáveis.</span><span class="sxs-lookup"><span data-stu-id="65b4e-111">Generally, additions to gRPC services and methods are non-breaking.</span></span> <span data-ttu-id="65b4e-112">Alterações sem interrupção permitem que os clientes existentes continuem a funcionar sem alterações.</span><span class="sxs-lookup"><span data-stu-id="65b4e-112">Non-breaking changes allow existing clients to continue working without changes.</span></span> <span data-ttu-id="65b4e-113">Alterar ou excluir os serviços gRPCs são alterações significativas.</span><span class="sxs-lookup"><span data-stu-id="65b4e-113">Changing or deleting gRPC services are breaking changes.</span></span> <span data-ttu-id="65b4e-114">Quando os serviços gRPCs têm alterações significativas, os clientes que usam esse serviço precisam ser atualizados e reimplantados.</span><span class="sxs-lookup"><span data-stu-id="65b4e-114">When gRPC services have breaking changes, clients using that service have to be updated and redeployed.</span></span>

<span data-ttu-id="65b4e-115">Fazer alterações não significativas em um serviço tem vários benefícios:</span><span class="sxs-lookup"><span data-stu-id="65b4e-115">Making non-breaking changes to a service has a number of benefits:</span></span>

* <span data-ttu-id="65b4e-116">Os clientes existentes continuam a ser executados.</span><span class="sxs-lookup"><span data-stu-id="65b4e-116">Existing clients continue to run.</span></span>
* <span data-ttu-id="65b4e-117">Evita o trabalho envolvido em notificar os clientes sobre alterações significativas e atualizá-los.</span><span class="sxs-lookup"><span data-stu-id="65b4e-117">Avoids work involved with notifying clients of breaking changes, and updating them.</span></span>
* <span data-ttu-id="65b4e-118">Somente uma versão do serviço precisa ser documentada e mantida.</span><span class="sxs-lookup"><span data-stu-id="65b4e-118">Only one version of the service needs to be documented and maintained.</span></span>

### <a name="non-breaking-changes"></a><span data-ttu-id="65b4e-119">Alterações não relacionadas à falha</span><span class="sxs-lookup"><span data-stu-id="65b4e-119">Non-breaking changes</span></span>

<span data-ttu-id="65b4e-120">Essas alterações não são significativas em um nível de protocolo gRPC e no nível binário do .NET.</span><span class="sxs-lookup"><span data-stu-id="65b4e-120">These changes are non-breaking at a gRPC protocol level and .NET binary level.</span></span>

* <span data-ttu-id="65b4e-121">**Adicionando um novo serviço**</span><span class="sxs-lookup"><span data-stu-id="65b4e-121">**Adding a new service**</span></span>
* <span data-ttu-id="65b4e-122">**Adicionando um novo método a um serviço**</span><span class="sxs-lookup"><span data-stu-id="65b4e-122">**Adding a new method to a service**</span></span>
* <span data-ttu-id="65b4e-123">A **adição de um campo a uma mensagem de solicitação** -campos adicionados a uma mensagem de solicitação são desserializados com o [valor padrão](https://developers.google.com/protocol-buffers/docs/proto3#default) no servidor quando não definido.</span><span class="sxs-lookup"><span data-stu-id="65b4e-123">**Adding a field to a request message** - Fields added to a request message are deserialized with the [default value](https://developers.google.com/protocol-buffers/docs/proto3#default) on the server when not set.</span></span> <span data-ttu-id="65b4e-124">Para ser uma alteração não significativa, o serviço deve ter sucesso quando o novo campo não é definido por clientes mais antigos.</span><span class="sxs-lookup"><span data-stu-id="65b4e-124">To be a non-breaking change, the service must succeed when the new field isn't set by older clients.</span></span>
* <span data-ttu-id="65b4e-125">**Adicionar um campo a uma mensagem de resposta** -os campos adicionados a uma mensagem de resposta são desserializados na coleção de [campos desconhecidos](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) da mensagem no cliente.</span><span class="sxs-lookup"><span data-stu-id="65b4e-125">**Adding a field to a response message** - Fields added to a response message are deserialized into the message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) collection on the client.</span></span>
* <span data-ttu-id="65b4e-126">**Adicionar um valor a enum** -enums é serializado como um valor numérico.</span><span class="sxs-lookup"><span data-stu-id="65b4e-126">**Adding a value to an enum** - Enums are serialized as a numeric value.</span></span> <span data-ttu-id="65b4e-127">Novos valores de enumeração são desserializados no cliente para o valor de enumeração sem um nome de enumeração.</span><span class="sxs-lookup"><span data-stu-id="65b4e-127">New enum values are deserialized on the client to the enum value without an enum name.</span></span> <span data-ttu-id="65b4e-128">Para ser uma alteração não significativa, os clientes mais antigos devem ser executados corretamente ao receber o novo valor de enumeração.</span><span class="sxs-lookup"><span data-stu-id="65b4e-128">To be a non-breaking change, older clients must run correctly when receiving the new enum value.</span></span>

### <a name="binary-breaking-changes"></a><span data-ttu-id="65b4e-129">Alterações de quebra binária</span><span class="sxs-lookup"><span data-stu-id="65b4e-129">Binary breaking changes</span></span>

<span data-ttu-id="65b4e-130">As alterações a seguir são não separáveis em um nível de protocolo gRPC, mas o cliente precisa ser atualizado se ele atualizar para o conjunto de módulos *. proto* ou o assembly de cliente .net mais recente.</span><span class="sxs-lookup"><span data-stu-id="65b4e-130">The following changes are non-breaking at a gRPC protocol level, but the client needs to be updated if it upgrades to the latest *.proto* contract or client .NET assembly.</span></span> <span data-ttu-id="65b4e-131">A compatibilidade binária é importante se você planeja publicar uma biblioteca gRPC no NuGet.</span><span class="sxs-lookup"><span data-stu-id="65b4e-131">Binary compatibility is important if you plan to publish a gRPC library to NuGet.</span></span>

* <span data-ttu-id="65b4e-132">A **remoção de um campo** -valores de um campo removido são desserializados para os [campos desconhecidos](https://developers.google.com/protocol-buffers/docs/proto3#unknowns)de uma mensagem.</span><span class="sxs-lookup"><span data-stu-id="65b4e-132">**Removing a field** - Values from a removed field are deserialized to a message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns).</span></span> <span data-ttu-id="65b4e-133">Isso não é uma alteração significativa de protocolo gRPC, mas o cliente precisa ser atualizado se ele atualizar para o contrato mais recente.</span><span class="sxs-lookup"><span data-stu-id="65b4e-133">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span> <span data-ttu-id="65b4e-134">É importante que um número de campo removido não seja acidentalmente reutilizado no futuro.</span><span class="sxs-lookup"><span data-stu-id="65b4e-134">It's important that a removed field number isn't accidentally reused in the future.</span></span> <span data-ttu-id="65b4e-135">Para garantir que isso não aconteça, especifique os números e nomes dos campos excluídos na mensagem usando a palavra-chave [reservada](https://developers.google.com/protocol-buffers/docs/proto3#reserved) do Protobuf.</span><span class="sxs-lookup"><span data-stu-id="65b4e-135">To ensure this doesn't happen, specify deleted field numbers and names on the message using Protobuf's [reserved](https://developers.google.com/protocol-buffers/docs/proto3#reserved) keyword.</span></span>
* <span data-ttu-id="65b4e-136">**Renomear uma mensagem** -nomes de mensagens normalmente não são enviados na rede, portanto, isso não é uma alteração de interrupção de protocolo gRPC.</span><span class="sxs-lookup"><span data-stu-id="65b4e-136">**Renaming a message** - Message names aren't typically sent on the network, so this isn't a gRPC protocol breaking change.</span></span> <span data-ttu-id="65b4e-137">O cliente precisará ser atualizado se atualizar para o contrato mais recente.</span><span class="sxs-lookup"><span data-stu-id="65b4e-137">The client will need to be updated if it upgrades to the latest contract.</span></span> <span data-ttu-id="65b4e-138">Uma situação em que os nomes de mensagem **são** enviados na rede é com [qualquer](https://developers.google.com/protocol-buffers/docs/proto3#any) campo, quando o nome da mensagem é usado para identificar o tipo de mensagem.</span><span class="sxs-lookup"><span data-stu-id="65b4e-138">One situation where message names **are** sent on the network is with [Any](https://developers.google.com/protocol-buffers/docs/proto3#any) fields, when the message name is used to identify the message type.</span></span>
* <span data-ttu-id="65b4e-139">Alterar a `csharp_namespace` de alteração de **csharp_namespace** alterará o namespace dos tipos .net gerados.</span><span class="sxs-lookup"><span data-stu-id="65b4e-139">**Changing csharp_namespace** - Changing `csharp_namespace` will change the namespace of generated .NET types.</span></span> <span data-ttu-id="65b4e-140">Isso não é uma alteração significativa de protocolo gRPC, mas o cliente precisa ser atualizado se ele atualizar para o contrato mais recente.</span><span class="sxs-lookup"><span data-stu-id="65b4e-140">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span>

### <a name="protocol-breaking-changes"></a><span data-ttu-id="65b4e-141">Alterações significativas de protocolo</span><span class="sxs-lookup"><span data-stu-id="65b4e-141">Protocol breaking changes</span></span>

<span data-ttu-id="65b4e-142">Os itens a seguir são alterações de protocolo e de quebra binária:</span><span class="sxs-lookup"><span data-stu-id="65b4e-142">The following items are protocol and binary breaking changes:</span></span>

* <span data-ttu-id="65b4e-143">**Renomeando um campo** -com conteúdo Protobuf, os nomes de campo são usados somente no código gerado.</span><span class="sxs-lookup"><span data-stu-id="65b4e-143">**Renaming a field** - With Protobuf content, the field names are only used in generated code.</span></span> <span data-ttu-id="65b4e-144">O número do campo é usado para identificar campos na rede.</span><span class="sxs-lookup"><span data-stu-id="65b4e-144">The field number is used to identify fields on the network.</span></span> <span data-ttu-id="65b4e-145">Renomear um campo não é uma alteração significativa de protocolo para Protobuf.</span><span class="sxs-lookup"><span data-stu-id="65b4e-145">Renaming a field isn't a protocol breaking change for Protobuf.</span></span> <span data-ttu-id="65b4e-146">No entanto, se um servidor estiver usando conteúdo JSON, renomear um campo será uma alteração significativa.</span><span class="sxs-lookup"><span data-stu-id="65b4e-146">However, if a server is using JSON content then renaming a field is a breaking change.</span></span>
* <span data-ttu-id="65b4e-147">**Alterar um tipo de dados de campo** – alterar o tipo de dados de um campo para um [tipo incompatível](https://developers.google.com/protocol-buffers/docs/proto3#updating) causará erros ao desserializar a mensagem.</span><span class="sxs-lookup"><span data-stu-id="65b4e-147">**Changing a field data type** - Changing a field's data type to an [incompatible type](https://developers.google.com/protocol-buffers/docs/proto3#updating) will cause errors when deserializing the message.</span></span> <span data-ttu-id="65b4e-148">Mesmo que o novo tipo de dados seja compatível, é provável que o cliente precise ser atualizado para dar suporte ao novo tipo se ele atualizar para o contrato mais recente.</span><span class="sxs-lookup"><span data-stu-id="65b4e-148">Even if the new data type is compatible, it's likely the client needs to be updated to support the new type if it upgrades to the latest contract.</span></span>
* <span data-ttu-id="65b4e-149">**Alterando um número de campo** -com cargas de Protobuf, o número do campo é usado para identificar campos na rede.</span><span class="sxs-lookup"><span data-stu-id="65b4e-149">**Changing a field number** - With Protobuf payloads, the field number is used to identify fields on the network.</span></span>
* <span data-ttu-id="65b4e-150">**Renomear um pacote, serviço ou método** -gRPC usa o nome do pacote, o nome do serviço e o nome do método para criar a URL.</span><span class="sxs-lookup"><span data-stu-id="65b4e-150">**Renaming a package, service or method** - gRPC uses the package name, service name, and method name to build the URL.</span></span> <span data-ttu-id="65b4e-151">O cliente recebe um status não *implementado* do servidor.</span><span class="sxs-lookup"><span data-stu-id="65b4e-151">The client gets an *UNIMPLEMENTED* status from the server.</span></span>
* <span data-ttu-id="65b4e-152">**Removendo um serviço ou método** -o cliente obtém um status não *implementado* do servidor ao chamar o método removido.</span><span class="sxs-lookup"><span data-stu-id="65b4e-152">**Removing a service or method** - The client gets an *UNIMPLEMENTED* status from the server when calling the removed method.</span></span>

### <a name="behavior-breaking-changes"></a><span data-ttu-id="65b4e-153">Alterações significativas de comportamento</span><span class="sxs-lookup"><span data-stu-id="65b4e-153">Behavior breaking changes</span></span>

<span data-ttu-id="65b4e-154">Ao fazer alterações não significativas, você também deve considerar se os clientes mais antigos podem continuar trabalhando com o novo comportamento do serviço.</span><span class="sxs-lookup"><span data-stu-id="65b4e-154">When making non-breaking changes, you must also consider whether older clients can continue working with the new service behavior.</span></span> <span data-ttu-id="65b4e-155">Por exemplo, adicionar um novo campo a uma mensagem de solicitação:</span><span class="sxs-lookup"><span data-stu-id="65b4e-155">For example, adding a new field to a request message:</span></span>

* <span data-ttu-id="65b4e-156">Não é uma alteração de interrupção de protocolo.</span><span class="sxs-lookup"><span data-stu-id="65b4e-156">Isn't a protocol breaking change.</span></span>
* <span data-ttu-id="65b4e-157">Retornando um status de erro no servidor se o novo campo não estiver definido, ele fará uma alteração significativa para clientes antigos.</span><span class="sxs-lookup"><span data-stu-id="65b4e-157">Returning an error status on the server if the new field isn't set makes it a breaking change for old clients.</span></span>

<span data-ttu-id="65b4e-158">A compatibilidade de comportamento é determinada pelo seu código específico do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="65b4e-158">Behavior compatibility is determined by your app-specific code.</span></span>

## <a name="version-number-services"></a><span data-ttu-id="65b4e-159">Serviços de número de versão</span><span class="sxs-lookup"><span data-stu-id="65b4e-159">Version number services</span></span>

<span data-ttu-id="65b4e-160">Os serviços devem se esforçar para manter a compatibilidade com os clientes antigos.</span><span class="sxs-lookup"><span data-stu-id="65b4e-160">Services should strive to remain backwards compatible with old clients.</span></span> <span data-ttu-id="65b4e-161">Eventualmente, alterações em seu aplicativo podem exigir alterações significativas.</span><span class="sxs-lookup"><span data-stu-id="65b4e-161">Eventually changes to your app may require breaking changes.</span></span> <span data-ttu-id="65b4e-162">Dividir clientes antigos e forçá-los a ser atualizados junto com seu serviço não é uma boa experiência do usuário.</span><span class="sxs-lookup"><span data-stu-id="65b4e-162">Breaking old clients and forcing them to be updated along with your service isn't a good user experience.</span></span> <span data-ttu-id="65b4e-163">Uma maneira de manter a compatibilidade com versões anteriores ao fazer alterações significativas é publicar várias versões de um serviço.</span><span class="sxs-lookup"><span data-stu-id="65b4e-163">A way to maintain backwards compatibility while making breaking changes is to publish multiple versions of a service.</span></span>

<span data-ttu-id="65b4e-164">o gRPC dá suporte a um especificador de [pacote](https://developers.google.com/protocol-buffers/docs/proto3#packages) opcional, que funciona de forma muito semelhante a um namespace .net.</span><span class="sxs-lookup"><span data-stu-id="65b4e-164">gRPC supports an optional [package](https://developers.google.com/protocol-buffers/docs/proto3#packages) specifier, which functions much like a .NET namespace.</span></span> <span data-ttu-id="65b4e-165">Na verdade, o `package` será usado como o namespace .NET para tipos .NET gerados se `option csharp_namespace` não estiver definido no arquivo *. proto* .</span><span class="sxs-lookup"><span data-stu-id="65b4e-165">In fact, the `package` will be used as the .NET namespace for generated .NET types if `option csharp_namespace` is not set in the *.proto* file.</span></span> <span data-ttu-id="65b4e-166">O pacote pode ser usado para especificar um número de versão para seu serviço e suas mensagens:</span><span class="sxs-lookup"><span data-stu-id="65b4e-166">The package can be used to specify a version number for your service and its messages:</span></span>

[!code-protobuf[](versioning/sample/greet.v1.proto?highlight=3)]

<span data-ttu-id="65b4e-167">O nome do pacote é combinado com o nome do serviço para identificar um endereço de serviço.</span><span class="sxs-lookup"><span data-stu-id="65b4e-167">The package name is combined with the service name to identify a service address.</span></span> <span data-ttu-id="65b4e-168">Um endereço de serviço permite que várias versões de um serviço sejam hospedadas lado a lado:</span><span class="sxs-lookup"><span data-stu-id="65b4e-168">A service address allows multiple versions of a service to be hosted side-by-side:</span></span>

* `greet.v1.Greeter`
* `greet.v2.Greeter`

<span data-ttu-id="65b4e-169">As implementações do serviço com versão são registradas em *Startup.cs*:</span><span class="sxs-lookup"><span data-stu-id="65b4e-169">Implementations of the versioned service are registered in *Startup.cs*:</span></span>

```csharp
app.UseEndpoints(endpoints =>
{
    // Implements greet.v1.Greeter
    endpoints.MapGrpcService<GreeterServiceV1>();

    // Implements greet.v2.Greeter
    endpoints.MapGrpcService<GreeterServiceV2>();
});
```

<span data-ttu-id="65b4e-170">A inclusão de um número de versão no nome do pacote oferece a oportunidade de publicar uma versão *v2* do serviço com alterações significativas, enquanto continua a oferecer suporte a clientes mais antigos que chamam a versão *v1* .</span><span class="sxs-lookup"><span data-stu-id="65b4e-170">Including a version number in the package name gives you the opportunity to publish a *v2* version of your service with breaking changes, while continuing to support older clients who call the *v1* version.</span></span> <span data-ttu-id="65b4e-171">Depois que os clientes tiverem atualizado para usar o serviço *v2* , você pode optar por remover a versão antiga.</span><span class="sxs-lookup"><span data-stu-id="65b4e-171">Once clients have updated to use the *v2* service, you can choose to remove the old version.</span></span> <span data-ttu-id="65b4e-172">Ao planejar a publicação de várias versões de um serviço:</span><span class="sxs-lookup"><span data-stu-id="65b4e-172">When planning to publish multiple versions of a service:</span></span>

* <span data-ttu-id="65b4e-173">Evite alterações significativas, se for razoável.</span><span class="sxs-lookup"><span data-stu-id="65b4e-173">Avoid breaking changes if reasonable.</span></span>
* <span data-ttu-id="65b4e-174">Não atualize o número de versão, a menos que faça alterações significativas.</span><span class="sxs-lookup"><span data-stu-id="65b4e-174">Don't update the version number unless making breaking changes.</span></span>
* <span data-ttu-id="65b4e-175">Atualize o número de versão ao fazer alterações significativas.</span><span class="sxs-lookup"><span data-stu-id="65b4e-175">Do update the version number when you make breaking changes.</span></span>

<span data-ttu-id="65b4e-176">A publicação de várias versões de um serviço a duplica.</span><span class="sxs-lookup"><span data-stu-id="65b4e-176">Publishing multiple versions of a service duplicates it.</span></span> <span data-ttu-id="65b4e-177">Para reduzir a duplicação, considere a possibilidade de mover a lógica de negócios das implementações de serviço para um local centralizado que possa ser reutilizado pelas implementações novas e antigas:</span><span class="sxs-lookup"><span data-stu-id="65b4e-177">To reduce duplication, consider moving business logic from the service implementations to a centralized location that can be reused by the old and new implementations:</span></span>

[!code-csharp[](versioning/sample/GreeterServiceV1.cs?highlight=10,19)]

<span data-ttu-id="65b4e-178">Os serviços e as mensagens geradas com nomes de pacote diferentes são **tipos .net diferentes**.</span><span class="sxs-lookup"><span data-stu-id="65b4e-178">Services and messages generated with different package names are **different .NET types**.</span></span> <span data-ttu-id="65b4e-179">Mover a lógica de negócios para um local centralizado requer o mapeamento de mensagens para tipos comuns.</span><span class="sxs-lookup"><span data-stu-id="65b4e-179">Moving business logic to a centralized location requires mapping messages to common types.</span></span>
